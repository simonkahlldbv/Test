<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Modell Betrachter</title>
  <!-- Laden des model-viewer Skripts mit type="module" -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
    }
    #button-container {
      margin: 10px;
    }
    #button-container button.selected {
      background-color: beige;
    }
    .button-container button.selected {
      background-color: beige;
    }
    model-viewer.single-viewer {
      width: 100vw;
      height: 90vh;
      filter: brightness(1.3) contrast(1.1);
    }
    #viewer-container {
      width: 100%;
      height: 90vh;
    }
    #comparison-container {
      display: flex;
      width: 100%;
      height: 90vh;
    }
    .comparison-viewer {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .comparison-viewer .button-container {
      display: flex;
      justify-content: center;
      margin: 5px;
    }
    .comparison-viewer .button-container button.selected {
      background-color: beige;
    }
    model-viewer.compare-viewer {
      width: 100%;
      flex: 1;
      filter: brightness(1.3) contrast(1.1);
    }
    #end-comparison-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    #sync-toggle {
      position: absolute;
      top: 50px;
      right: 10px;
      z-index: 10;
      background-color: white;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="button-container">
    <!-- Buttons werden dynamisch generiert -->
  </div>

  <div id="viewer-container">
    <model-viewer id="model-viewer" class="single-viewer" src="1150.glb" alt="Ein 3D Modell" ar camera-controls
    min-camera-orbit="auto auto auto" max-camera-orbit="auto auto auto" min-field-of-view="10deg"
    max-field-of-view="45deg" exposure="0.6">
    </model-viewer>
  </div>

  <script>
    let isComparing = false;
    let syncCameras = false; // Variable zur Steuerung der Kamerasynchronisation
    let selectedModelSingle = '1150.glb';
    let selectedModelLeft = '1150.glb';
    let selectedModelRight = '1175.glb';

    const models = [
      {year: '1150', file: '1150.glb'},
      {year: '1175', file: '1175.glb'},
      {year: '1374', file: '1374.glb'},
      {year: '1550', file: '1550.glb'},
      {year: '1630', file: '1630.glb'},
      {year: '1830', file: '1830.glb'},
      {year: '1936', file: '1936.glb'},
      {year: '2023', file: '2023.glb'},
    ];

    // Buttons für die Einzelansicht generieren
    generateModelButtonsSingle();

    function generateModelButtonsSingle() {
      const buttonContainer = document.getElementById('button-container');
      let buttonsHTML = '';
      models.forEach(model => {
        buttonsHTML += `<button data-file="${model.file}" onclick="changeModel('${model.file}')">${model.year}</button>`;
      });
      buttonsHTML += `<button onclick="startComparison()">Vergleichen</button>`;
      buttonContainer.innerHTML = buttonsHTML;

      // Markieren des ausgewählten Modells
      updateSelectedButtonSingle();
    }

    function changeModel(modelFile, side) {
      if (isComparing) {
        const modelViewerId = side === 'left' ? 'model-viewer-left' : 'model-viewer-right';
        const modelViewer = document.getElementById(modelViewerId);

        // Kameraeinstellungen speichern
        const cameraState = getCameraState(modelViewer);

        modelViewer.src = modelFile;

        // Aktualisieren des ausgewählten Modells
        if (side === 'left') {
          selectedModelLeft = modelFile;
          updateSelectedButtonComparison('left');
        } else {
          selectedModelRight = modelFile;
          updateSelectedButtonComparison('right');
        }

        // Warten, bis das Modell geladen ist
        modelViewer.addEventListener('load', () => {
          // Kameraeinstellungen anwenden
          setCameraState(modelViewer, cameraState);
        }, { once: true });
      } else {
        const modelViewer = document.getElementById('model-viewer');

        // Kameraeinstellungen speichern
        const cameraState = getCameraState(modelViewer);

        modelViewer.src = modelFile;
        selectedModelSingle = modelFile;
        updateSelectedButtonSingle();

        // Warten, bis das Modell geladen ist
        modelViewer.addEventListener('load', () => {
          // Kameraeinstellungen anwenden
          setCameraState(modelViewer, cameraState);
        }, { once: true });
      }
    }

    function startComparison() {
      isComparing = true;
      document.getElementById('button-container').style.display = 'none';

      const viewerContainer = document.getElementById('viewer-container');
      viewerContainer.innerHTML = `
        <div id="comparison-container">
          <div class="comparison-viewer">
            <div class="button-container" id="button-container-left">
              <!-- Buttons für das linke Modell -->
            </div>
            <model-viewer id="model-viewer-left" class="compare-viewer" src="${selectedModelLeft}" alt="Ein 3D Modell" ar camera-controls
            min-camera-orbit="auto auto auto" max-camera-orbit="auto auto auto" min-field-of-view="10deg" max-field-of-view="45deg" exposure="0.6">
            </model-viewer>
          </div>
          <div class="comparison-viewer">
            <div class="button-container" id="button-container-right">
              <!-- Buttons für das rechte Modell -->
            </div>
            <model-viewer id="model-viewer-right" class="compare-viewer" src="${selectedModelRight}" alt="Ein 3D Modell" ar camera-controls
            min-camera-orbit="auto auto auto" max-camera-orbit="auto auto auto" min-field-of-view="10deg" max-field-of-view="45deg" exposure="0.6">
            </model-viewer>
          </div>
        </div>
        <button id="end-comparison-button" onclick="endComparison()">Vergleich beenden</button>
        <label id="sync-toggle">
          <input type="checkbox" id="sync-checkbox" onchange="toggleSync(this.checked)"> Kameras synchronisieren
        </label>
      `;

      generateModelButtons('left');
      generateModelButtons('right');

      // Event Listener für Kamerasynchronisation hinzufügen
      const modelViewerLeft = document.getElementById('model-viewer-left');
      const modelViewerRight = document.getElementById('model-viewer-right');

      modelViewerLeft.addEventListener('camera-change', (event) => {
        if (syncCameras && event.detail.source === 'user-interaction') {
          syncCamera(modelViewerLeft, modelViewerRight);
        }
      });

      modelViewerRight.addEventListener('camera-change', (event) => {
        if (syncCameras && event.detail.source === 'user-interaction') {
          syncCamera(modelViewerRight, modelViewerLeft);
        }
      });
    }

    function syncCamera(source, target) {
      const cameraState = getCameraState(source);

      // Kameraeinstellungen direkt anwenden
      setCameraState(target, cameraState);
    }

    function getCameraState(modelViewer) {
      return {
        orbit: modelViewer.getCameraOrbit(),
        target: modelViewer.getCameraTarget(),
        fov: modelViewer.getFieldOfView()
      };
    }

    function setCameraState(modelViewer, state) {
      modelViewer.cameraOrbit = `${state.orbit.theta}rad ${state.orbit.phi}rad ${state.orbit.radius}m`;
      modelViewer.cameraTarget = `${state.target.x}m ${state.target.y}m ${state.target.z}m`;
      modelViewer.fieldOfView = `${state.fov}deg`;
    }

    function endComparison() {
      isComparing = false;
      syncCameras = false;
      document.getElementById('button-container').style.display = 'block';

      const viewerContainer = document.getElementById('viewer-container');
      viewerContainer.innerHTML = `
        <model-viewer id="model-viewer" class="single-viewer" src="${selectedModelSingle}" alt="Ein 3D Modell" ar camera-controls
        min-camera-orbit="auto auto auto" max-camera-orbit="auto auto auto" min-field-of-view="10deg"
        max-field-of-view="45deg" exposure="0.6">
        </model-viewer>
      `;

      // Buttons neu generieren und markieren
      generateModelButtonsSingle();
    }

    function generateModelButtons(side) {
      const containerId = side === 'left' ? 'button-container-left' : 'button-container-right';
      const buttonContainer = document.getElementById(containerId);
      let buttonsHTML = '';
      models.forEach(model => {
        buttonsHTML += `<button data-file="${model.file}" onclick="changeModel('${model.file}', '${side}')">${model.year}</button>`;
      });
      buttonContainer.innerHTML = buttonsHTML;

      // Markieren des ausgewählten Modells
      updateSelectedButtonComparison(side);
    }

    function updateSelectedButtonSingle() {
      const buttons = document.querySelectorAll('#button-container button[data-file]');
      buttons.forEach(button => {
        if (button.getAttribute('data-file') === selectedModelSingle) {
          button.classList.add('selected');
        } else {
          button.classList.remove('selected');
        }
      });
    }

    function updateSelectedButtonComparison(side) {
      const containerId = side === 'left' ? 'button-container-left' : 'button-container-right';
      const selectedModel = side === 'left' ? selectedModelLeft : selectedModelRight;
      const buttons = document.querySelectorAll(`#${containerId} button[data-file]`);
      buttons.forEach(button => {
        if (button.getAttribute('data-file') === selectedModel) {
          button.classList.add('selected');
        } else {
          button.classList.remove('selected');
        }
      });
    }

    function toggleSync(isChecked) {
      syncCameras = isChecked;

      const modelViewerLeft = document.getElementById('model-viewer-left');
      const modelViewerRight = document.getElementById('model-viewer-right');

      if (syncCameras) {
        // Benutzerinteraktion auf dem rechten Modell deaktivieren
        modelViewerRight.setAttribute('interaction-prompt', 'none');
        modelViewerLeft.setAttribute('interaction-prompt', 'none');

        // Kameraeinstellungen synchronisieren
        syncCamera(modelViewerLeft, modelViewerRight);
      } else {
        // Benutzerinteraktion auf dem rechten Modell wieder aktivieren
        modelViewerRight.setAttribute('camera-controls', '');
        modelViewerRight.removeAttribute('interaction-prompt');
      }
    }
  </script>
</body>
</html>
